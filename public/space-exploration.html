<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EIDOLON — The Last Signal</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;1,300;1,400&family=Space+Mono:ital@0;1&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --ink: #0a0c10;
  --dust: #1a1f2e;
  --fog: rgba(160,180,220,0.07);
  --amber: #c8902a;
  --amber-dim: rgba(200,144,42,0.3);
  --ice: #7ab8d4;
  --ice-dim: rgba(122,184,212,0.2);
  --text: #c4cdd8;
  --text-dim: rgba(196,205,216,0.45);
  --text-faint: rgba(196,205,216,0.2);
  --serif: 'Crimson Pro', Georgia, serif;
  --mono: 'Space Mono', monospace;
}

html, body {
  width: 100%; height: 100%;
  background: var(--ink);
  color: var(--text);
  font-family: var(--serif);
  overflow: hidden;
  cursor: none;
}

/* Custom cursor */
#cursor {
  position: fixed;
  width: 6px; height: 6px;
  background: var(--amber);
  border-radius: 50%;
  pointer-events: none;
  z-index: 9999;
  transform: translate(-50%, -50%);
  transition: transform 0.1s, width 0.2s, height 0.2s, background 0.2s;
  box-shadow: 0 0 12px var(--amber);
}
#cursor.over-object {
  width: 14px; height: 14px;
  background: transparent;
  border: 1px solid var(--amber);
  box-shadow: 0 0 20px var(--amber-dim);
}
#cursor-trail {
  position: fixed;
  width: 24px; height: 24px;
  border: 1px solid rgba(200,144,42,0.2);
  border-radius: 50%;
  pointer-events: none;
  z-index: 9998;
  transform: translate(-50%, -50%);
  transition: left 0.15s ease, top 0.15s ease;
}

/* SCREENS */
.screen {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 1.2s ease;
}
.screen.active {
  opacity: 1;
  pointer-events: all;
}

/* Grain overlay */
body::before {
  content: '';
  position: fixed;
  inset: -50%;
  width: 200%; height: 200%;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
  opacity: 0.4;
  pointer-events: none;
  z-index: 9990;
  animation: grain 0.5s steps(2) infinite;
}
@keyframes grain {
  0% { transform: translate(0,0); }
  25% { transform: translate(-2%, -3%); }
  50% { transform: translate(3%, 1%); }
  75% { transform: translate(-1%, 2%); }
  100% { transform: translate(2%, -1%); }
}

/* ========================
   TITLE SCREEN
======================== */
#screen-title {
  background: radial-gradient(ellipse at 50% 60%, #0d1520 0%, var(--ink) 70%);
}

.title-canvas-wrap {
  position: absolute;
  inset: 0;
}

#title-stars {
  position: absolute;
  inset: 0;
  width: 100%; height: 100%;
}

.title-content {
  position: relative;
  z-index: 2;
  text-align: center;
}

.title-eyebrow {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 5px;
  color: var(--text-dim);
  text-transform: uppercase;
  margin-bottom: 24px;
  animation: fadeup 1.5s ease 0.5s both;
}

.title-main {
  font-family: var(--serif);
  font-weight: 300;
  font-size: clamp(52px, 8vw, 96px);
  letter-spacing: -2px;
  color: #fff;
  line-height: 1;
  margin-bottom: 8px;
  animation: fadeup 1.5s ease 0.8s both;
  text-shadow: 0 0 80px rgba(122,184,212,0.3);
}

.title-sub {
  font-family: var(--serif);
  font-style: italic;
  font-weight: 300;
  font-size: clamp(18px, 2.5vw, 26px);
  color: var(--ice);
  letter-spacing: 2px;
  margin-bottom: 60px;
  animation: fadeup 1.5s ease 1.1s both;
  opacity: 0.7;
}

.btn-start {
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--amber);
  background: none;
  border: 1px solid var(--amber-dim);
  padding: 14px 40px;
  cursor: none;
  transition: all 0.3s;
  animation: fadeup 1.5s ease 1.6s both;
  position: relative;
  overflow: hidden;
}
.btn-start::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--amber);
  transform: scaleX(0);
  transform-origin: left;
  transition: transform 0.3s ease;
  z-index: -1;
}
.btn-start:hover {
  color: var(--ink);
  border-color: var(--amber);
}
.btn-start:hover::before { transform: scaleX(1); }

@keyframes fadeup {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ========================
   EXPLORE SCREEN
======================== */
#screen-explore {
  padding: 0;
  overflow: hidden;
}

#explore-canvas {
  position: absolute;
  inset: 0;
  width: 100%; height: 100%;
}

/* Narrative overlay */
#narration {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  width: min(580px, 90vw);
  z-index: 100;
  pointer-events: none;
}

.narration-text {
  font-family: var(--serif);
  font-size: 17px;
  font-weight: 300;
  line-height: 1.7;
  color: var(--text);
  text-align: center;
  padding: 20px 28px;
  background: rgba(10,12,16,0.85);
  border: 1px solid rgba(196,205,216,0.08);
  border-radius: 2px;
  backdrop-filter: blur(12px);
  opacity: 0;
  transform: translateY(8px);
  transition: opacity 0.6s ease, transform 0.6s ease;
}
.narration-text.show {
  opacity: 1;
  transform: translateY(0);
}
.narration-text em { color: var(--ice); font-style: italic; }
.narration-text strong { color: var(--amber); font-style: normal; }

/* Object label */
#obj-label {
  position: fixed;
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--amber);
  text-transform: uppercase;
  pointer-events: none;
  z-index: 200;
  opacity: 0;
  transition: opacity 0.3s;
  background: rgba(10,12,16,0.7);
  padding: 4px 8px;
  border-left: 2px solid var(--amber);
}

/* Inventory bar */
#inventory {
  position: fixed;
  top: 28px;
  right: 28px;
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-width: 220px;
}

.inv-item {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--ice);
  padding: 6px 12px;
  border: 1px solid var(--ice-dim);
  background: rgba(10,12,16,0.8);
  backdrop-filter: blur(8px);
  letter-spacing: 1px;
  opacity: 0;
  transform: translateX(20px);
  transition: opacity 0.5s, transform 0.5s;
  cursor: none;
}
.inv-item.collected {
  opacity: 1;
  transform: translateX(0);
}
.inv-item:hover { background: rgba(122,184,212,0.1); }

/* Compass / location */
#location-tag {
  position: fixed;
  top: 28px;
  left: 28px;
  z-index: 100;
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 3px;
  color: var(--text-dim);
  text-transform: uppercase;
}
#location-tag .loc-name {
  font-size: 13px;
  color: var(--text);
  display: block;
  margin-bottom: 2px;
}

/* Fragment reader */
#fragment-reader {
  position: fixed;
  inset: 0;
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(10,12,16,0.92);
  backdrop-filter: blur(20px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s;
}
#fragment-reader.open {
  opacity: 1;
  pointer-events: all;
}

.fragment-card {
  width: min(560px, 88vw);
  border: 1px solid rgba(196,205,216,0.12);
  padding: 48px;
  position: relative;
  transform: translateY(20px);
  transition: transform 0.5s ease;
  background: rgba(15,20,30,0.95);
}
#fragment-reader.open .fragment-card {
  transform: translateY(0);
}

.fragment-type {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 4px;
  color: var(--amber);
  text-transform: uppercase;
  margin-bottom: 24px;
  opacity: 0.7;
}

.fragment-title {
  font-family: var(--serif);
  font-size: 28px;
  font-weight: 300;
  color: #fff;
  margin-bottom: 20px;
  line-height: 1.2;
}

.fragment-body {
  font-family: var(--serif);
  font-size: 16px;
  font-weight: 300;
  line-height: 1.8;
  color: var(--text);
}
.fragment-body p { margin-bottom: 12px; }
.fragment-body em { color: var(--ice); font-style: italic; }

.fragment-close {
  position: absolute;
  top: 20px; right: 20px;
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--text-dim);
  background: none;
  border: none;
  cursor: none;
  padding: 8px;
  transition: color 0.2s;
}
.fragment-close:hover { color: var(--amber); }

.fragment-number {
  position: absolute;
  bottom: 20px; right: 24px;
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-faint);
}

/* Ending screen */
#screen-ending {
  background: var(--ink);
  text-align: center;
  padding: 40px;
}

.ending-title {
  font-family: var(--serif);
  font-size: clamp(32px, 5vw, 56px);
  font-weight: 300;
  color: #fff;
  margin-bottom: 16px;
  opacity: 0;
  animation: fadeup 2s ease 0.5s both;
}

.ending-body {
  font-size: 18px;
  font-weight: 300;
  line-height: 1.8;
  color: var(--text);
  max-width: 500px;
  margin: 0 auto 40px;
  opacity: 0;
  animation: fadeup 2s ease 1s both;
}

.ending-restart {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 4px;
  color: var(--text-dim);
  background: none;
  border: none;
  cursor: none;
  opacity: 0;
  animation: fadeup 2s ease 2s both;
  transition: color 0.3s;
  text-transform: uppercase;
}
.ending-restart:hover { color: var(--amber); }

/* Progress dots */
#progress {
  position: fixed;
  bottom: 110px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 8px;
  z-index: 100;
}
.prog-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--text-faint);
  border: 1px solid rgba(196,205,216,0.15);
  transition: all 0.5s;
}
.prog-dot.found {
  background: var(--amber);
  box-shadow: 0 0 8px var(--amber);
}
</style>
</head>
<body>

<div id="cursor"></div>
<div id="cursor-trail"></div>

<!-- TITLE SCREEN -->
<div class="screen active" id="screen-title">
  <div class="title-canvas-wrap">
    <canvas id="title-stars"></canvas>
  </div>
  <div class="title-content">
    <div class="title-eyebrow">A story of first contact</div>
    <div class="title-main">EIDOLON</div>
    <div class="title-sub">The Last Signal</div>
    <button class="btn-start" id="btn-start">Begin Transmission</button>
  </div>
</div>

<!-- EXPLORE SCREEN -->
<div class="screen" id="screen-explore">
  <canvas id="explore-canvas"></canvas>

  <div id="location-tag">
    <span class="loc-name" id="loc-name">—</span>
    <span id="loc-sub">Scanning environment</span>
  </div>

  <div id="inventory"></div>

  <div id="progress"></div>

  <div id="narration">
    <div class="narration-text" id="narration-text"></div>
  </div>

  <div id="obj-label"></div>
</div>

<!-- FRAGMENT READER -->
<div id="fragment-reader">
  <div class="fragment-card">
    <div class="fragment-type" id="frag-type">—</div>
    <div class="fragment-title" id="frag-title">—</div>
    <div class="fragment-body" id="frag-body"></div>
    <button class="fragment-close" id="frag-close">[ CLOSE ]</button>
    <div class="fragment-number" id="frag-num"></div>
  </div>
</div>

<!-- ENDING SCREEN -->
<div class="screen" id="screen-ending">
  <div class="ending-title" id="ending-title">Signal Understood</div>
  <div class="ending-body" id="ending-body"></div>
  <button class="ending-restart" id="btn-restart">↩ transmit again</button>
</div>

<script>
// =====================
// CURSOR
// =====================
const cursor = document.getElementById('cursor');
const trail = document.getElementById('cursor-trail');
let mx = 0, my = 0;
document.addEventListener('mousemove', e => {
  mx = e.clientX; my = e.clientY;
  cursor.style.left = mx + 'px';
  cursor.style.top = my + 'px';
  setTimeout(() => {
    trail.style.left = mx + 'px';
    trail.style.top = my + 'px';
  }, 80);
});

function setCursorHover(on) {
  cursor.classList.toggle('over-object', on);
}

// =====================
// TITLE STARS
// =====================
const tsc = document.getElementById('title-stars');
const tctx = tsc.getContext('2d');
let tStars = [];

function initTitleStars() {
  tsc.width = window.innerWidth;
  tsc.height = window.innerHeight;
  tStars = Array.from({length: 200}, () => ({
    x: Math.random() * tsc.width,
    y: Math.random() * tsc.height,
    r: Math.random() * 1.2 + 0.3,
    phase: Math.random() * Math.PI * 2,
    speed: 0.003 + Math.random() * 0.008
  }));
}

function drawTitleStars() {
  tctx.clearRect(0, 0, tsc.width, tsc.height);
  const now = performance.now() / 1000;
  for (const s of tStars) {
    const a = 0.2 + 0.5 * Math.abs(Math.sin(now * s.speed + s.phase));
    tctx.beginPath();
    tctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    tctx.fillStyle = `rgba(200,220,255,${a})`;
    tctx.fill();
  }
}

initTitleStars();
window.addEventListener('resize', initTitleStars);

// =====================
// STORY DATA
// =====================
const LOCATIONS = [
  { id: 'crater', name: 'Virellan Crater', sub: '43.2°N · 88.7°W' },
  { id: 'ruins', name: 'Ancient Ruins', sub: 'Structure depth: ~40m' },
  { id: 'ship', name: 'Crashed Vessel', sub: 'Origin: Unknown' },
  { id: 'signal', name: 'Signal Source', sub: 'Frequency: 1420 MHz' },
];

const FRAGMENTS = [
  {
    id: 'log1',
    type: 'Personal Log',
    title: 'Day One',
    label: 'Worn Journal',
    inv: 'JOURNAL — DAY 1',
    body: `<p>The crater is quieter than I expected. Command told us to expect wind. There is no wind here. The dust doesn't move. I've been standing in this spot for twenty minutes and not a single grain has shifted.</p><p>Kael says it feels like the planet is <em>holding its breath.</em></p><p>I don't have a better description.</p>`,
    scene: 'crater',
    x: 0.28, y: 0.55,
    narration: `You crouch beside a half-buried object. <em>A journal.</em> The pages are intact, perfectly preserved in the airless cold.`,
    color: '#c8902a', shape: 'rect', size: 14
  },
  {
    id: 'glyph',
    type: 'Artifact',
    title: 'The First Mark',
    label: 'Stone Glyph',
    inv: 'GLYPH FRAGMENT',
    body: `<p>The symbol doesn't match any catalogued language. It's carved into basalt with impossible precision — the groove width is uniform to within two microns. No tool we carry could do this.</p><p>But stranger than the carving is the feeling when you press your glove against it. A warmth that shouldn't exist in negative forty degrees. <em>As if someone left it here recently.</em></p><p>As if someone knew you were coming.</p>`,
    scene: 'ruins',
    x: 0.62, y: 0.43,
    narration: `The ruin wall holds a mark unlike anything in human record. <strong>Your instruments go quiet</strong> the moment you approach it.`,
    color: '#7ab8d4', shape: 'circle', size: 18
  },
  {
    id: 'recording',
    type: 'Audio Fragment',
    title: 'Static, Then a Voice',
    label: 'Distress Beacon',
    inv: 'AUDIO: 44s',
    body: `<p>The first nineteen seconds are static. Then a voice — <em>your own voice</em> — reading coordinates. Not these coordinates. Coordinates twenty kilometers north, in a direction the team hasn't traveled yet.</p><p>The recording is time-stamped <strong>six days from now.</strong></p><p>Kael reaches over and turns it off. Neither of you speaks for a long time.</p><p>"Do we go north?" he finally asks.</p>`,
    scene: 'ship',
    x: 0.42, y: 0.60,
    narration: `The distress beacon is still active. You play the recording. <em>What you hear makes your hands go still.</em>`,
    color: '#e06060', shape: 'diamond', size: 16
  },
  {
    id: 'transmission',
    type: 'The Signal',
    title: 'What It Was Saying',
    label: 'Signal Origin',
    inv: 'DECODED SIGNAL',
    body: `<p>The signal has been broadcasting for eleven thousand years. You know this because it contains a counter — a simple, patient count from zero to this moment.</p><p>The message itself is four words, repeated in every human language simultaneously, as if <em>it always knew</em> which ones we would make:</p><p style="text-align:center; font-size: 22px; color: #fff; padding: 16px 0; letter-spacing: 3px;"><em>"You were not alone."</em></p><p>Past tense.</p><p>You sit with that for a long time, in the dust that doesn't move, on a planet that held its breath until you arrived to hear the last thing it wanted to say.</p>`,
    scene: 'signal',
    x: 0.50, y: 0.45,
    narration: `You've found it. The source of everything. <strong>Eleven thousand years of patience</strong>, waiting for this exact moment.`,
    color: '#a87ad4', shape: 'star', size: 22
  },
];

// =====================
// GAME STATE
// =====================
let currentScene = 0;
let collected = [];
let fragmentReaderOpen = false;
let hoveredFrag = null;
let activeNarration = null;
let narrationTimer = null;

// =====================
// SCENE RENDERER
// =====================
const ec = document.getElementById('explore-canvas');
const ectx = ec.getContext('2d');
let W, H;
let animFrame = 0;
let particles = [];

function resize() {
  W = ec.width = window.innerWidth;
  H = ec.height = window.innerHeight;
  initParticles();
}

function initParticles() {
  particles = Array.from({length: 60}, () => ({
    x: Math.random() * W,
    y: Math.random() * H,
    vx: (Math.random() - 0.5) * 0.15,
    vy: -Math.random() * 0.1,
    size: Math.random() * 2 + 0.5,
    alpha: Math.random() * 0.3
  }));
}

function getSceneFragments() {
  const sid = LOCATIONS[currentScene].id;
  return FRAGMENTS.filter(f => f.scene === sid);
}

function drawScene() {
  ectx.clearRect(0, 0, W, H);
  const t = animFrame / 60;
  const scene = LOCATIONS[currentScene].id;

  // BACKGROUND GRADIENT per scene
  const bgs = {
    crater: [['#0a0e18', 0], ['#121a2a', 0.5], ['#1a1008', 1]],
    ruins:  [['#080c14', 0], ['#0e1520', 0.5], ['#080e18', 1]],
    ship:   [['#0c0a10', 0], ['#14101a', 0.5], ['#0a080c', 1]],
    signal: [['#08060e', 0], ['#10081c', 0.5], ['#060412', 1]],
  };
  const bg = bgs[scene] || bgs.crater;
  const grad = ectx.createLinearGradient(0, 0, 0, H);
  for (const [c, s] of bg) grad.addColorStop(s, c);
  ectx.fillStyle = grad;
  ectx.fillRect(0, 0, W, H);

  // Scene-specific environment
  if (scene === 'crater') drawCraterScene(t);
  else if (scene === 'ruins') drawRuinsScene(t);
  else if (scene === 'ship') drawShipScene(t);
  else if (scene === 'signal') drawSignalScene(t);

  // Floating particles
  for (const p of particles) {
    p.x += p.vx; p.y += p.vy;
    if (p.y < -10) { p.y = H + 10; p.x = Math.random() * W; }
    if (p.x < 0) p.x = W;
    if (p.x > W) p.x = 0;
    ectx.beginPath();
    ectx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ectx.fillStyle = `rgba(200,220,255,${p.alpha})`;
    ectx.fill();
  }

  // Draw interactive objects
  const frags = getSceneFragments();
  for (const f of frags) {
    if (collected.includes(f.id)) continue;
    const fx = f.x * W;
    const fy = f.y * H;
    const hover = hoveredFrag === f.id;
    const pulse = 0.7 + 0.3 * Math.sin(t * 2 + f.x * 10);

    ectx.save();
    ectx.shadowColor = f.color;
    ectx.shadowBlur = hover ? 30 : 12 * pulse;

    ectx.globalAlpha = hover ? 1 : 0.7 + 0.3 * pulse;

    if (f.shape === 'circle') {
      ectx.beginPath();
      ectx.arc(fx, fy, f.size, 0, Math.PI * 2);
      ectx.fillStyle = f.color + '30';
      ectx.fill();
      ectx.strokeStyle = f.color;
      ectx.lineWidth = 1.5;
      ectx.stroke();
    } else if (f.shape === 'rect') {
      ectx.strokeStyle = f.color;
      ectx.lineWidth = 1.5;
      ectx.strokeRect(fx - f.size, fy - f.size * 0.7, f.size * 2, f.size * 1.4);
      ectx.fillStyle = f.color + '20';
      ectx.fillRect(fx - f.size, fy - f.size * 0.7, f.size * 2, f.size * 1.4);
    } else if (f.shape === 'diamond') {
      ectx.beginPath();
      ectx.moveTo(fx, fy - f.size);
      ectx.lineTo(fx + f.size * 0.7, fy);
      ectx.lineTo(fx, fy + f.size);
      ectx.lineTo(fx - f.size * 0.7, fy);
      ectx.closePath();
      ectx.fillStyle = f.color + '25';
      ectx.fill();
      ectx.strokeStyle = f.color;
      ectx.lineWidth = 1.5;
      ectx.stroke();
    } else if (f.shape === 'star') {
      drawStar(ectx, fx, fy, 5, f.size, f.size * 0.45, f.color);
    }

    // Hover ring
    if (hover) {
      ectx.beginPath();
      ectx.arc(fx, fy, f.size * 2, 0, Math.PI * 2);
      ectx.strokeStyle = f.color + '40';
      ectx.lineWidth = 1;
      ectx.stroke();
    }

    ectx.restore();
  }

  animFrame++;
  requestAnimationFrame(drawScene);
}

function drawStar(ctx, cx, cy, spikes, outerR, innerR, color) {
  let rot = (Math.PI / 2) * 3;
  const step = Math.PI / spikes;
  ctx.beginPath();
  ctx.moveTo(cx, cy - outerR);
  for (let i = 0; i < spikes; i++) {
    ctx.lineTo(cx + Math.cos(rot) * outerR, cy + Math.sin(rot) * outerR);
    rot += step;
    ctx.lineTo(cx + Math.cos(rot) * innerR, cy + Math.sin(rot) * innerR);
    rot += step;
  }
  ctx.closePath();
  ctx.fillStyle = color + '25';
  ctx.fill();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  ctx.stroke();
}

// Scene drawings
function drawCraterScene(t) {
  // Horizon
  const hg = ectx.createLinearGradient(0, H * 0.5, 0, H);
  hg.addColorStop(0, '#1a1208');
  hg.addColorStop(1, '#0a0c10');
  ectx.fillStyle = hg;
  ectx.fillRect(0, H * 0.55, W, H * 0.45);

  // Crater rim silhouette
  ectx.beginPath();
  ectx.moveTo(0, H * 0.58);
  for (let x = 0; x <= W; x += 20) {
    const y = H * 0.55 + Math.sin(x * 0.008) * 40 + Math.sin(x * 0.003) * 60;
    ectx.lineTo(x, y);
  }
  ectx.lineTo(W, H); ectx.lineTo(0, H);
  ectx.fillStyle = '#120e08';
  ectx.fill();

  // Two moons
  drawMoon(ectx, W * 0.72, H * 0.18, 38, '#d4c090', t * 0.05);
  drawMoon(ectx, W * 0.15, H * 0.12, 18, '#a0b4c8', t * 0.03);

  // Stars
  drawBackgroundStars(ectx, W, H * 0.56, 180, t);

  // Fog at base
  const fg = ectx.createLinearGradient(0, H * 0.7, 0, H);
  fg.addColorStop(0, 'transparent');
  fg.addColorStop(1, 'rgba(20,16,10,0.9)');
  ectx.fillStyle = fg;
  ectx.fillRect(0, H * 0.55, W, H * 0.45);
}

function drawRuinsScene(t) {
  drawBackgroundStars(ectx, W, H * 0.65, 120, t);

  // Ground
  const g = ectx.createLinearGradient(0, H * 0.6, 0, H);
  g.addColorStop(0, '#0e1220');
  g.addColorStop(1, '#070910');
  ectx.fillStyle = g;
  ectx.fillRect(0, H * 0.62, W, H * 0.38);

  // Ruin pillars
  const pillars = [0.1, 0.22, 0.35, 0.55, 0.7, 0.82, 0.92];
  for (const px of pillars) {
    const ph = 80 + Math.sin(px * 10) * 120;
    const pw = 18 + Math.sin(px * 7) * 8;
    const broken = px > 0.5;
    ectx.fillStyle = '#1a2035';
    ectx.fillRect(px * W - pw / 2, H * 0.62 - ph, pw, ph + 20);
    if (broken) {
      ectx.fillStyle = '#0e1525';
      ectx.fillRect(px * W - pw / 2, H * 0.62 - ph, pw, ph * 0.4);
    }
  }

  // Atmospheric glow
  const ag = ectx.createRadialGradient(W * 0.5, H * 0.55, 0, W * 0.5, H * 0.55, W * 0.4);
  ag.addColorStop(0, 'rgba(122,184,212,0.04)');
  ag.addColorStop(1, 'transparent');
  ectx.fillStyle = ag;
  ectx.fillRect(0, 0, W, H);
}

function drawShipScene(t) {
  drawBackgroundStars(ectx, W, H * 0.6, 100, t);

  // Ground
  ectx.fillStyle = '#0c0a10';
  ectx.fillRect(0, H * 0.65, W, H * 0.35);

  // Crashed ship silhouette
  ectx.save();
  ectx.translate(W * 0.5, H * 0.64);
  ectx.rotate(-0.08);

  // Hull
  ectx.beginPath();
  ectx.moveTo(-200, 0);
  ectx.quadraticCurveTo(-160, -60, 0, -50);
  ectx.quadraticCurveTo(160, -40, 200, 10);
  ectx.lineTo(200, 30);
  ectx.lineTo(-200, 30);
  ectx.closePath();
  ectx.fillStyle = '#1a1520';
  ectx.fill();
  ectx.strokeStyle = '#2a2535';
  ectx.lineWidth = 1;
  ectx.stroke();

  // Broken wing
  ectx.beginPath();
  ectx.moveTo(100, -10);
  ectx.lineTo(280, -80);
  ectx.lineTo(300, -60);
  ectx.lineTo(120, 10);
  ectx.fillStyle = '#151220';
  ectx.fill();

  // Windows (some lit)
  for (let i = -3; i <= 1; i++) {
    const wx = i * 45;
    const lit = i === -1 || i === 1;
    ectx.beginPath();
    ectx.arc(wx, -30, 8, 0, Math.PI * 2);
    ectx.fillStyle = lit ? 'rgba(120,180,255,0.3)' : '#0a0814';
    ectx.fill();
    if (lit) {
      ectx.shadowColor = '#7ab8ff';
      ectx.shadowBlur = 15;
      ectx.fill();
      ectx.shadowBlur = 0;
    }
    ectx.strokeStyle = '#3a3545';
    ectx.lineWidth = 1;
    ectx.stroke();
  }

  ectx.restore();

  // Debris glow
  const dg = ectx.createRadialGradient(W * 0.5, H * 0.65, 0, W * 0.5, H * 0.65, 300);
  dg.addColorStop(0, 'rgba(255,100,50,0.06)');
  dg.addColorStop(1, 'transparent');
  ectx.fillStyle = dg;
  ectx.fillRect(0, 0, W, H);
}

function drawSignalScene(t) {
  // Deep space
  drawBackgroundStars(ectx, W, H, 250, t);

  // Signal tower
  ectx.save();
  ectx.translate(W * 0.5, H * 0.9);

  // Base
  ectx.beginPath();
  ectx.moveTo(-40, 0); ectx.lineTo(40, 0); ectx.lineTo(20, -30); ectx.lineTo(-20, -30);
  ectx.fillStyle = '#1a1a2a';
  ectx.fill();

  // Tower
  for (let i = 0; i < 5; i++) {
    const w = 20 - i * 3;
    const y = -30 - i * 50;
    ectx.strokeStyle = i % 2 === 0 ? '#2a2a3a' : '#1a1a2a';
    ectx.lineWidth = w;
    ectx.beginPath();
    ectx.moveTo(0, y); ectx.lineTo(0, y - 50);
    ectx.stroke();
  }

  ectx.restore();

  // Signal rings
  for (let r = 1; r <= 5; r++) {
    const phase = (t * 0.8 + r * 0.5) % 5;
    const radius = phase * 100;
    const alpha = (1 - phase / 5) * 0.3;
    ectx.beginPath();
    ectx.arc(W * 0.5, H * 0.65, radius, 0, Math.PI * 2);
    ectx.strokeStyle = `rgba(168,122,212,${alpha})`;
    ectx.lineWidth = 2;
    ectx.stroke();
  }

  // Central glow
  const cg = ectx.createRadialGradient(W * 0.5, H * 0.65, 0, W * 0.5, H * 0.65, 200);
  cg.addColorStop(0, 'rgba(168,122,212,0.15)');
  cg.addColorStop(1, 'transparent');
  ectx.fillStyle = cg;
  ectx.fillRect(0, 0, W, H);

  // Ground
  ectx.fillStyle = '#080610';
  ectx.fillRect(0, H * 0.88, W, H * 0.12);
}

function drawBackgroundStars(ctx, w, maxH, count, t) {
  for (let i = 0; i < count; i++) {
    const sx = ((i * 137.5) % w);
    const sy = ((i * 97.3) % maxH);
    const a = 0.1 + 0.4 * Math.abs(Math.sin(t * 0.5 + i));
    const r = 0.5 + (i % 3) * 0.4;
    ctx.beginPath();
    ctx.arc(sx, sy, r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(200,210,230,${a})`;
    ctx.fill();
  }
}

function drawMoon(ctx, x, y, r, color, t) {
  const mg = ctx.createRadialGradient(x - r * 0.3, y - r * 0.3, 0, x, y, r);
  mg.addColorStop(0, '#fff8');
  mg.addColorStop(0.5, color);
  mg.addColorStop(1, 'transparent');
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI * 2);
  ctx.fillStyle = mg;
  ctx.fill();
}

// =====================
// INTERACTION
// =====================
const objLabel = document.getElementById('obj-label');

ec.addEventListener('mousemove', e => {
  if (fragmentReaderOpen) return;
  const frags = getSceneFragments();
  let found = null;
  for (const f of frags) {
    if (collected.includes(f.id)) continue;
    const fx = f.x * W, fy = f.y * H;
    const dist = Math.hypot(e.clientX - fx, e.clientY - fy);
    if (dist < 40) { found = f; break; }
  }
  hoveredFrag = found ? found.id : null;
  setCursorHover(!!found);
  if (found) {
    objLabel.style.left = (e.clientX + 18) + 'px';
    objLabel.style.top = (e.clientY - 10) + 'px';
    objLabel.textContent = found.label;
    objLabel.style.opacity = '1';
  } else {
    objLabel.style.opacity = '0';
  }
});

ec.addEventListener('click', e => {
  if (fragmentReaderOpen) return;
  const frags = getSceneFragments();
  for (const f of frags) {
    if (collected.includes(f.id)) continue;
    const fx = f.x * W, fy = f.y * H;
    const dist = Math.hypot(e.clientX - fx, e.clientY - fy);
    if (dist < 50) {
      openFragment(f);
      return;
    }
  }
});

function openFragment(f) {
  collected.push(f.id);
  fragmentReaderOpen = true;

  document.getElementById('frag-type').textContent = f.type;
  document.getElementById('frag-title').textContent = f.title;
  document.getElementById('frag-body').innerHTML = f.body;
  document.getElementById('frag-num').textContent = `${collected.length} / ${FRAGMENTS.length}`;
  document.getElementById('fragment-reader').classList.add('open');

  addInvItem(f);
  showNarration(f.narration);
  updateProgress();
}

document.getElementById('frag-close').addEventListener('click', () => {
  document.getElementById('fragment-reader').classList.remove('open');
  fragmentReaderOpen = false;

  // Check if scene is done → advance
  const frags = getSceneFragments();
  const allDone = frags.every(f => collected.includes(f.id));
  if (allDone) {
    if (currentScene < LOCATIONS.length - 1) {
      setTimeout(advanceScene, 800);
    } else {
      setTimeout(showEnding, 1200);
    }
  }
});

// =====================
// UI UPDATES
// =====================
function addInvItem(f) {
  const inv = document.getElementById('inventory');
  const el = document.createElement('div');
  el.className = 'inv-item';
  el.textContent = f.inv;
  el.dataset.id = f.id;
  el.style.borderColor = f.color + '50';
  el.style.color = f.color;
  inv.appendChild(el);
  requestAnimationFrame(() => el.classList.add('collected'));

  el.addEventListener('click', () => {
    openFragment(f);
    fragmentReaderOpen = true;
  });
  el.addEventListener('mouseenter', () => setCursorHover(true));
  el.addEventListener('mouseleave', () => setCursorHover(false));
}

function updateProgress() {
  const prog = document.getElementById('progress');
  prog.innerHTML = '';
  for (let i = 0; i < FRAGMENTS.length; i++) {
    const d = document.createElement('div');
    d.className = 'prog-dot' + (i < collected.length ? ' found' : '');
    prog.appendChild(d);
  }
}

function showNarration(text) {
  const el = document.getElementById('narration-text');
  el.innerHTML = text;
  el.classList.add('show');
  if (narrationTimer) clearTimeout(narrationTimer);
  narrationTimer = setTimeout(() => el.classList.remove('show'), 6000);
}

function advanceScene() {
  currentScene++;
  const loc = LOCATIONS[currentScene];
  document.getElementById('loc-name').textContent = loc.name;
  document.getElementById('loc-sub').textContent = loc.sub;

  const messages = [
    'You move deeper into the crater. The silence follows.',
    'The ruins rise from the dust, impossibly old.',
    'The wreckage is cold. Everything here stopped mid-motion.',
  ];
  showNarration(messages[currentScene - 1] || '');
}

function showEnding() {
  switchScreen('screen-explore', 'screen-ending');
}

// =====================
// SCREEN TRANSITIONS
// =====================
function switchScreen(from, to) {
  document.getElementById(from).classList.remove('active');
  setTimeout(() => {
    document.getElementById(to).classList.add('active');
  }, 400);
}

// =====================
// START
// =====================
document.getElementById('btn-start').addEventListener('click', () => {
  switchScreen('screen-title', 'screen-explore');

  resize();
  window.addEventListener('resize', resize);
  drawScene();

  const loc = LOCATIONS[0];
  document.getElementById('loc-name').textContent = loc.name;
  document.getElementById('loc-sub').textContent = loc.sub;

  updateProgress();

  setTimeout(() => {
    showNarration(`You are the last crew member on the surface. <em>Your ship is gone.</em> Something down here was worth staying for.`);
  }, 1200);
});

document.getElementById('btn-restart').addEventListener('click', () => {
  currentScene = 0;
  collected = [];
  fragmentReaderOpen = false;

  document.getElementById('inventory').innerHTML = '';
  document.getElementById('progress').innerHTML = '';
  updateProgress();

  const loc = LOCATIONS[0];
  document.getElementById('loc-name').textContent = loc.name;
  document.getElementById('loc-sub').textContent = loc.sub;

  switchScreen('screen-ending', 'screen-title');
});

document.getElementById('btn-start').addEventListener('mouseenter', () => setCursorHover(true));
document.getElementById('btn-start').addEventListener('mouseleave', () => setCursorHover(false));
document.getElementById('frag-close').addEventListener('mouseenter', () => setCursorHover(true));
document.getElementById('frag-close').addEventListener('mouseleave', () => setCursorHover(false));

// Ending setup
document.getElementById('ending-body').textContent =
  `You sit in the crater's silence, the signal's last words still turning in your mind. You came here looking for something. You found proof that something was here long before you — and spent eleven millennia waiting to be understood.`;

// MAIN LOOP (title + explore concurrent)
function mainLoop() {
  drawTitleStars();
  requestAnimationFrame(mainLoop);
}
mainLoop();
</script>
</body>
</html>
